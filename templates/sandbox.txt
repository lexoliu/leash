(version 1)
(deny default)

; System basics - Mach IPC, sysctl
(allow mach*)
(allow sysctl-read)

; Hardware access configuration
{% if allow_gpu %}
; GPU access - Metal, OpenGL, OpenCL
(allow iokit-open (iokit-user-client-class "IOAccelerator"))
(allow iokit-open (iokit-user-client-class "IOAccelerationUserClient"))
(allow iokit-open (iokit-user-client-class "AGXDeviceUserClient"))
(allow iokit-open (iokit-user-client-class "IOSurfaceRootUserClient"))
(allow iokit-open (iokit-user-client-class "IOSurfaceSendRight"))
{% endif %}
{% if allow_npu %}
; NPU/Neural Engine access - CoreML, ANE (Apple Neural Engine)
(allow iokit-open (iokit-user-client-class "H11ANEInDirectPathClient"))
(allow iokit-open (iokit-user-client-class "AppleNeuralEngineUserClient"))
{% endif %}
{% if allow_hardware %}
; General hardware access - USB, Bluetooth, cameras, etc.
(allow iokit-open)
{% endif %}

; Process operations
(allow process-fork)
(allow process-exec)
(allow signal)
(allow ipc-posix*)
(allow file-lock)

; Allow file metadata reads (needed for symlink resolution, os.path.exists, etc.)
(allow file-read-metadata)

; File read access - allow broadly but deny sensitive paths below
(allow file-read*)

; Explicit dyld loader access (required on modern macOS)
(allow file-read* (literal "/usr/lib/dyld"))

; Security rules from SecurityConfig
{% for rule in security_deny_rules %}
{{ rule }}
{% endfor %}

; Temp directories (full read + write including create/unlink)
(allow file-read* (subpath "/private/tmp"))
(allow file-read* (subpath "/tmp"))
(allow file-read* (subpath "/var/folders"))
(allow file-read* (subpath "/private/var/folders"))
(allow file-write* (subpath "/private/tmp"))
(allow file-write* (subpath "/tmp"))
(allow file-write* (subpath "/var/folders"))
(allow file-write* (subpath "/private/var/folders"))
(allow file-write-create (subpath "/private/tmp"))
(allow file-write-create (subpath "/tmp"))
(allow file-write-create (subpath "/var/folders"))
(allow file-write-create (subpath "/private/var/folders"))
(allow file-write-unlink (subpath "/private/tmp"))
(allow file-write-unlink (subpath "/tmp"))
(allow file-write-unlink (subpath "/var/folders"))
(allow file-write-unlink (subpath "/private/var/folders"))

; Device access - minimal set for stdio and randomness
(allow file-read* (literal "/dev/null"))
(allow file-read* (literal "/dev/zero"))
(allow file-read* (literal "/dev/random"))
(allow file-read* (literal "/dev/urandom"))
(allow file-read* (subpath "/dev/fd"))
(allow file-read* (literal "/dev/tty"))
(allow file-write* (literal "/dev/null"))
(allow file-write* (literal "/dev/zero"))
(allow file-write* (subpath "/dev/fd"))
(allow file-write* (literal "/dev/tty"))

; Configured readable paths (override denials)
{% for path in readable_paths %}
(allow file-read* (subpath "{{ path }}"))
{% endfor %}
; Configured writable paths (includes all write operations: data, create, unlink, rename)
{% for path in writable_paths %}
(allow file-read* (subpath "{{ path }}"))
(allow file-write* (subpath "{{ path }}"))
(allow file-write-create (subpath "{{ path }}"))
(allow file-write-unlink (subpath "{{ path }}"))
{% endfor %}
; Configured executable paths
{% for path in executable_paths %}
(allow file-read* (literal "{{ path }}"))
(allow process-exec (literal "{{ path }}"))
{% endfor %}
; Working directory (override denials, full read + write including create/unlink)
(allow file-read* (subpath "{{ working_dir }}"))
(allow file-write* (subpath "{{ working_dir }}"))
(allow file-write-create (subpath "{{ working_dir }}"))
(allow file-write-unlink (subpath "{{ working_dir }}"))

{% if let Some(venv_path) = python_venv_path %}
; Python venv (full access for pip install)
(allow file-read* (subpath "{{ venv_path }}"))
(allow file-write* (subpath "{{ venv_path }}"))
(allow file-write-create (subpath "{{ venv_path }}"))
(allow file-write-unlink (subpath "{{ venv_path }}"))
(allow process-exec (subpath "{{ venv_path }}"))
; Homebrew Python (common on macOS)
(allow file-read* (subpath "/opt/homebrew/Cellar/python"))
(allow file-read* (subpath "/opt/homebrew/Frameworks/Python.framework"))
(allow file-read* (subpath "/opt/homebrew/opt/python"))
(allow process-exec (subpath "/opt/homebrew/Cellar/python"))
(allow process-exec (subpath "/opt/homebrew/Frameworks/Python.framework"))
{% endif %}

; Network: only allow connections to localhost (all traffic goes through proxy)
(deny network*)
(allow network* (local ip "localhost:*"))
(allow network* (remote ip "localhost:*"))
(allow network* (local unix-socket))
